local TS = game:GetService("TweenService")
local CutScene = game.Workspace.Map.Functional.CutScenes
local DoorToggle = false
local PlrDead = false
local ForestAttack = false

local DSS = game:GetService("DataStoreService")
local Global = DSS:GetGlobalDataStore()


game.Lighting.Ambient = Color3.new(0,0,0)
game.Lighting.OutdoorAmbient = Color3.new(0.14902, 0.14902, 0.14902)
game.Lighting.Brightness = 0
game.Lighting.GlobalShadows = true
game.Lighting.ClockTime = 0

local function ToggleLight()
	for i,v in pairs(game.Workspace.Map.Functional.Lights:GetChildren()) do
		if v:IsA("Part") and v.Name ~= "FluorescentLightRoofGasStationSign" then
			v.Light.SurfaceLight.Enabled = not v.Light.SurfaceLight.Enabled
			v.Light.LightSoundEffect.Playing = not v.Light.LightSoundEffect.Playing
			if v.Light.Material == Enum.Material.Neon then v.Light.Material = Enum.Material.Glass else v.Light.Material = Enum.Material.Neon end
		end
	end
end

local function ToggleLampPosts()
	for i,v in pairs(game.Workspace.Map.Functional.LampPosts:GetChildren()) do
		if v:IsA("Model") then
			for i,vv in pairs(v:GetDescendants()) do
				if vv:IsA("SurfaceLight") then
					vv.Enabled = not vv.Enabled
				end
			end
		end
	end
end

game.ReplicatedStorage.ToggleLight.OnServerEvent:Connect(function()
	ToggleLight()
end)

game.ReplicatedStorage.GameStart.OnServerEvent:Connect(function(Plr)
	Plr.Character:FindFirstChild("Humanoid").WalkSpeed = 10
end)

game.Workspace.Settings.Power.Changed:Connect(function(Value)
	if Value == true then
		for i,v in pairs(game.Workspace.Map.Functional.Lights:GetChildren()) do
			if v:IsA("Part") and v.Name ~= "FluorescentLightRoofGasStationSign" then
				v.Light.SurfaceLight.Enabled = true
				v.Light.LightSoundEffect.Playing = true
			end
		end
	else
		for i,v in pairs(game.Workspace.Map.Functional.Lights:GetChildren()) do
			if v:IsA("Part") and v.Name ~= "FluorescentLightRoofGasStationSign" then
				v.Light.SurfaceLight.Enabled = false
				v.Light.LightSoundEffect.Playing = false
			end
		end
	end
end)

game.ReplicatedStorage.EndGame.OnServerEvent:Connect(function(Plr,Data)
	if Data == "JD" then
		wait(math.random(1,3))
		
		for i,v in pairs(Plr.Backpack:GetChildren()) do
			v:Destroy()
		end
		
		game.ReplicatedStorage.Speech:FireAllClients({"Mother","How was your shift?"})
		wait(5)
		game.ReplicatedStorage.Speech:FireAllClients({"You","It was weird"})
		wait(4)
		game.ReplicatedStorage.Speech:FireAllClients({"Mother","I think your just tired. Get some rest."})
		wait(4)
		game.Workspace.Settings.OutroSceneCompleted.Value = true
		
		wait(9)
		
		game.Lighting.Blur.Enabled = true
		game.Lighting.Blur.Size = 56
		
		CutScene.JeremyDeathScene.PoliceCarLight2.FlickerRed.Siren.Volume = 0
		CutScene.JeremyDeathScene.PoliceCarLight1.FlickerRed.Siren.Volume = 0
		
		CutScene.JeremyDeathScene.PoliceCarLight1.FlickerRed.Siren:Play()
		CutScene.JeremyDeathScene.PoliceCarLight2.FlickerRed.Siren:Play()
		
		for i = 1,56 do
			wait(0.1)
			game.Lighting.Blur.Size -= 1
			CutScene.JeremyDeathScene.PoliceCarLight2.FlickerRed.Siren.Volume += 0.01
			CutScene.JeremyDeathScene.PoliceCarLight1.FlickerRed.Siren.Volume += 0.01
		end
		
		for i = 1,44 do
			wait(0.1)
			CutScene.JeremyDeathScene.PoliceCarLight2.FlickerRed.Siren.Volume += 0.01
			CutScene.JeremyDeathScene.PoliceCarLight1.FlickerRed.Siren.Volume += 0.01
		end
		wait(35)
		for i = 1,100 do
			wait(0.1)
			CutScene.JeremyDeathScene.PoliceCarLight2.FlickerRed.Siren.Volume -= 0.01
			CutScene.JeremyDeathScene.PoliceCarLight1.FlickerRed.Siren.Volume -= 0.01
		end
	end
end)

game.Players.PlayerAdded:Connect(function(Plr)
	
	local HasBox = Instance.new("BoolValue")
	HasBox.Parent = Plr
	HasBox.Name = "HasBox"
	HasBox.Value = false
	
	local FE = Instance.new("BoolValue")
	FE.Parent = Plr
	FE.Name = "ForestEnding"
	FE.Value = false
	
	local CE = Instance.new("BoolValue")
	CE.Parent = Plr
	CE.Name = "CarEnding"
	CE.Value = false
	
	local WTE = Instance.new("BoolValue")
	WTE.Parent = Plr
	WTE.Name = "WrongTimeEnding"
	WTE.Value = false
	
	local HE = Instance.new("BoolValue")
	HE.Parent = Plr
	HE.Name = "HomeEnding"
	HE.Value = false
	
	local PlrData = Global:GetAsync(Plr.UserId)
	
	if PlrData then
		FE.Value = PlrData[1]
		CE.Value = PlrData[2]
		WTE.Value = PlrData[3]
		HE.Value = PlrData[4]
	else
		Global:SetAsync(Plr.UserId,{})
	end
	
	
	Plr.CharacterAdded:Connect(function(Char)
		Char.Humanoid.Died:Connect(function()
			PlrDead = true
		end)
	end)
end)

game.Players.PlayerRemoving:Connect(function(Plr)
	local Data = {Plr:FindFirstChild("ForestEnding").Value, Plr:FindFirstChild("CarEnding").Value, Plr:FindFirstChild("WrongTimeEnding").Value,Plr:FindFirstChild("HomeEnding").Value}
	Global:SetAsync(Plr.UserId,Data)
end)

game.ReplicatedStorage.ToggleDoor.OnServerEvent:Connect(function(Plr,DoorPart)
	if DoorToggle == false then
		DoorToggle = true
		DoorPart.DoorToggle:Play()
		if DoorPart.Parent.Toggle.Value == false then
			DoorPart.Parent.Toggle.Value = true
			wait(0.1)
			TS:Create(DoorPart.Parent.Hinge, TweenInfo.new(1,Enum.EasingStyle.Linear,Enum.EasingDirection.Out,0,false,0), {CFrame = DoorPart.Parent.Hinge.CFrame * CFrame.Angles(0,math.rad(255), 0)}):Play()
			wait(1.1)
			DoorToggle = false
		else
			DoorPart.Parent.Toggle.Value = false
			wait(0.1)
			TS:Create(DoorPart.Parent.Hinge, TweenInfo.new(1,Enum.EasingStyle.Linear,Enum.EasingDirection.Out,0,false,0), {CFrame = DoorPart.Parent.Hinge.CFrame * CFrame.Angles(0,math.rad(-255), 0)}):Play()
			wait(1.1)
			DoorToggle = false
		end
	end
end)

game.Workspace.Map.Functional.SoundEffectChanger.Touched:Connect(function(Par)
	if Par.Parent:FindFirstChild("Humanoid") then
		game.SoundService.AmbientReverb = Enum.ReverbType.Room
	end
end)

game.Workspace.Map.Functional.SoundEffectChanger.TouchEnded:Connect(function(Par)
	if Par.Parent:FindFirstChild("Humanoid") and Par.Parent == game.Players:FindFirstChildWhichIsA("Player").Character then
		game.SoundService.AmbientReverb = Enum.ReverbType.Forest
	end
end)

for i,v in pairs(game.Workspace.Map.Functional.ForestBarriers:GetChildren()) do
	if v:IsA("Part") then
		v.Touched:Connect(function(Par)
			if Par.Parent:FindFirstChild("Humanoid") and Par.Parent.Name ~= "Creature" and Par.Parent.Name ~= "DecoyEntity" or Par.Parent.Name == "Jeremy" then
				if ForestAttack == false then
					ForestAttack = true
					local Monster = game.ServerStorage.Creature:Clone()
					local Plr = game.Players:FindFirstChildWhichIsA("Player")
					Monster.Parent = workspace
					Monster.Torso.Position = Plr.Character.Torso.Position + Vector3.new(math.random(20,30),0,math.random(10,20))
					Monster.Torso.Approaching:Play()
					Monster.Humanoid:MoveTo(game.Players:FindFirstChildWhichIsA("Player").Character.Torso.Position)
					
					game.Workspace.Map.Functional.Radio.RadioPart.RadioGlitch:Stop()
					
					ToggleLampPosts()
					ToggleLight()
					
					wait(math.random(1,20)/10)
					Plr.Character.Humanoid.WalkSpeed = 0
					wait(0.1)
					if Plr.Character:FindFirstChildWhichIsA("Tool") then
						Plr.Character:FindFirstChildWhichIsA("Tool"):Destroy()
					end
					wait(1)
					Monster.Torso.CFrame = Plr.Character.HumanoidRootPart.CFrame*CFrame.new(Vector3.new(0,0,-3))
					Monster.Torso.CFrame = CFrame.new(Monster.Torso.Position,Plr.Character.Torso.Position)
					
					Monster.Torso.Approaching:Stop()
					Monster.Torso.Jumpscare:Play()
					game.ReplicatedStorage.EndGame:FireAllClients("ForestEntranceEnding")
				end
			end
		end)
	end
end

game.ReplicatedStorage.KickPlr.OnServerEvent:Connect(function(Plr,EndingType)
	if EndingType == "ForestEntranceEnding" then
		game.BadgeService:AwardBadge(Plr.UserId,2140897524)
		Plr:FindFirstChild("ForestEnding").Value = true
		wait(3)
		game.Players:FindFirstChildWhichIsA("Player"):Kick("Forest Ending.")
	elseif EndingType == "CarEnding" then
		game.BadgeService:AwardBadge(Plr.UserId,2140896817)
		Plr:FindFirstChild("CarEnding").Value = true
		wait(3)
		game.Players:FindFirstChildWhichIsA("Player"):Kick("Car Ending.")
	elseif EndingType == "WrongTimingEnding" then
		game.BadgeService:AwardBadge(Plr.UserId,2140896828)
		Plr:FindFirstChild("WrongTimeEnding").Value = true
		wait(3)
		game.Players:FindFirstChildWhichIsA("Player"):Kick("Wrong place, Wrong Time ending")
	elseif EndingType == "HomeEnding" then
		game.BadgeService:AwardBadge(Plr.UserId,2140896821)
		Plr:FindFirstChild("HomeEnding").Value = true
		wait(3)
		game.Players:FindFirstChildWhichIsA("Player"):Kick("Home Sweet Home Ending. Chapter 2 will be unlocked when released.")
	elseif EndingType == "CheaterEnding" then
		Plr:Kick("Cheat Detected.")
	else
		Plr:Kick("Cheat Detected")
	end
end)

game.ReplicatedStorage.GiveTool.OnServerEvent:Connect(function(Plr,Part)
	local Tool = game.ServerStorage.Tools:FindFirstChild(Part.Name):Clone()
	
	if Tool then
		if Part.Name == "Cardboard Box" then
			if Plr.Backpack:FindFirstChild(Part.Name) or Plr:FindFirstChild("HasBox").Value == true then
				wait()
			else
				Tool.Parent = Plr.Backpack
				Plr:FindFirstChild("HasBox").Value = true
			end
		else
			if Plr.Backpack:FindFirstChild(Part.Name) then
				wait()
			else
				Tool.Parent = Plr.Backpack
				game.Workspace.Map.Functional.SoundEffectChanger.PickUp:Play()
				game.ReplicatedStorage.Note:FireAllClients("Picked Up "..Part.Name)
				Part.Parent:Destroy()
			end
		end
	end
end)

game.ReplicatedStorage.RemoveTool.OnServerEvent:Connect(function(Plr,Part)
	local Tool = Plr.Backpack:FindFirstChild(Part.Name)
	
	
	if Tool then
		Tool:Destroy()
	else
		local Tool2 = Plr.Character:FindFirstChild(Part.Name)
		
		
		if Tool2 then
			if Part.Name == "Cardboard Box" then
				game.ReplicatedStorage.StopBoxAnimation:FireAllClients()
				Plr:FindFirstChild("HasBox").Value = false
			end
			
			Tool2:Destroy()
		end
	end
end)

game.ReplicatedStorage.ClientToClientSpeech.OnServerEvent:Connect(function(Plr,Data)
	game.ReplicatedStorage.Speech:FireAllClients(Data)
end)

game.ReplicatedStorage.StartIntroScene.OnServerEvent:Connect(function(Plr)
	game.Workspace.Map.Functional.StartCar.CarEngine:Play()
	TS:Create(game.Workspace.Map.Functional.StartCar, TweenInfo.new(15,Enum.EasingStyle.Sine,Enum.EasingDirection.Out,0,false,0), {CFrame = CFrame.new(-1216.957, 8.642, 434.814)}):Play()
	wait(15)
	game.Workspace.Settings.IntroSceneCompleted.Value = true
	game.Workspace.Map.Functional.StartCar.DoorClosing:Play()
	Plr.Character.Torso.CFrame = CFrame.new(-1203.121, 9.364, 431.589)
	game.ReplicatedStorage.Speech:FireAllClients({"Mother","I will pick you up after your shift ends."})
	wait(7)
	game.ReplicatedStorage.Speech:FireAllClients({"You","Ok."})
	wait(4)
	game.ReplicatedStorage.SetObjective:FireAllClients({"Objective","Clock In"})
	TS:Create(game.Workspace.Map.Functional.StartCar, TweenInfo.new(15,Enum.EasingStyle.Sine,Enum.EasingDirection.In,0,false,0), {CFrame = CFrame.new(-1216.957, 8.642, -3.763)}):Play()
	wait(15)
	game.Workspace.Map.Functional.StartCar:Destroy()
end)

game.ReplicatedStorage.RemoveProduct.OnServerEvent:Connect(function(Plr,Productname)
	if game.Workspace:FindFirstChild(Productname) then
		game.Workspace:FindFirstChild(Productname):Destroy()
	end
end)

--[[Shelf Updater]]--

game.Workspace.Settings.ShelfStocked.Shelf1.Changed:Connect(function()
	if game.Workspace.Settings.ShelfStocked.Shelf1.Value == true or game.Workspace.Settings.ShelfStocked.Shelf2.Value == true or game.Workspace.Settings.ShelfStocked.Shelf3.Value == true then
		game.ReplicatedStorage.SetObjective:FireAllClients({"New Objective","Attend any Customers"})
	end
end)

game.Workspace.Settings.ShelfStocked.Shelf2.Changed:Connect(function()
	if game.Workspace.Settings.ShelfStocked.Shelf1.Value == true or game.Workspace.Settings.ShelfStocked.Shelf2.Value == true or game.Workspace.Settings.ShelfStocked.Shelf3.Value == true then
		game.ReplicatedStorage.SetObjective:FireAllClients({"New Objective","Attend any Customers"})
	end
end)

game.Workspace.Settings.ShelfStocked.Shelf3.Changed:Connect(function()
	if game.Workspace.Settings.ShelfStocked.Shelf1.Value == true or game.Workspace.Settings.ShelfStocked.Shelf2.Value == true or game.Workspace.Settings.ShelfStocked.Shelf3.Value == true then
		game.ReplicatedStorage.SetObjective:FireAllClients({"New Objective","Attend any Customers"})
	end
end)


while true do
	wait(0.1)
	local Plr = game.Players:FindFirstChildWhichIsA("Player")
	if Plr then
		if Plr:FindFirstChild("HasBox") then
			if Plr:FindFirstChild("HasBox").Value == true then
				if Plr.Character:FindFirstChildWhichIsA("Tool") then
					local Tool = Plr.Character:FindFirstChildWhichIsA("Tool")
					if Tool.Name == "Cardboard Box" then
						wait()
					else
						Tool.Parent = Plr.Backpack
						if Plr.Backpack:FindFirstChild("Cardboard Box") then
							Plr.Backpack:FindFirstChild("Cardboard Box").Parent = Plr.Character
						else
							local NewBox = game.ServerStorage.Tools["Cardboard Box"]:Clone()
							NewBox.Parent = Plr.Character
						end
					end
				else
					if Plr.Backpack:FindFirstChild("Cardboard Box") then
						Plr.Backpack:FindFirstChild("Cardboard Box").Parent = Plr.Character
					else
						local NewBox = game.ServerStorage.Tools["Cardboard Box"]:Clone()
						NewBox.Parent = Plr.Character
					end
				end
			end
		end
	end
end
